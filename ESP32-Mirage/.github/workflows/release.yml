---
name: Release

on:
  push:
    tags:
      - "v*.*.*"
      - "v*.*.*-*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version tag (e.g., v1.0.0)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  build_all_boards:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # NOTE: When adding a new board, update this list in all three workflow files:
        # - pr-gate.yml
        # - ci.yml  
        # - release.yml
        # Also update chip detection logic below for new chip types.
        board:
          - esp32dev
          - lilygo-t-display
          - esp32-geek
          - m5stack-core-esp32
          - m5stack-cores3
          - m5stack-cardputer
          - m5stick-c-plus
          - m5stick-c-plus2

    steps:
      - uses: actions/checkout@v4

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.platformio/.cache
          key: ${{ runner.os }}-pio-${{ matrix.board }}-${{ hashFiles('**/platformio.ini') }}
          restore-keys: |
            ${{ runner.os }}-pio-${{ matrix.board }}-
            ${{ runner.os }}-pio-

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install PlatformIO Core
        run: pip install -U platformio

      - name: Build Firmware for ${{ matrix.board }}
        run: |
          set -x
          pio run -e ${{ matrix.board }}

      - name: Get version info
        id: version
        run: |
          set -x
          
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            version="${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref_type }}" == "tag" ]]; then
            version=${{ github.ref_name }}
          else
            version="${GITHUB_SHA::7}"
          fi
          
          echo "version=${version}" >> $GITHUB_OUTPUT

      - name: Install esptool
        run: pip install -U esptool

      - name: Create merged firmware binary
        run: |
          set -x
          cd .pio/build/${{ matrix.board }}
          
          # Detect chip type based on board
          case "${{ matrix.board }}" in
            esp32-geek)
              chip="esp32c3"
              bootloader_offset="0x0000"
              partition_offset="0x8000"
              app_offset="0x10000"
              ;;
            m5stack-cardputer|m5stack-cores3)
              chip="esp32s3"
              bootloader_offset="0x0000"
              partition_offset="0x8000"
              app_offset="0x10000"
              ;;
            *)
              chip="esp32"
              bootloader_offset="0x1000"
              partition_offset="0x8000"
              app_offset="0x10000"
              ;;
          esac
          
          # Check which files exist and merge
          if [ -f "bootloader.bin" ] && [ -f "partitions.bin" ] && [ -f "firmware.bin" ]; then
            esptool.py --chip ${chip} merge_bin \
              --output ESP32-Mirage-${{ steps.version.outputs.version }}-${{ matrix.board }}.bin \
              ${bootloader_offset} bootloader.bin \
              ${partition_offset} partitions.bin \
              ${app_offset} firmware.bin
          else
            # Fallback: just copy firmware.bin with version name
            cp firmware.bin ESP32-Mirage-${{ steps.version.outputs.version }}-${{ matrix.board }}.bin
          fi

      - name: List build artifacts
        if: always()
        continue-on-error: true
        run: |
          set -x
          pwd
          ls -lah .pio/build/${{ matrix.board }}/
          tree .pio/build/${{ matrix.board }}/ || true

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.board }}
          path: .pio/build/${{ matrix.board }}/ESP32-Mirage-${{ steps.version.outputs.version }}-${{ matrix.board }}.bin
          if-no-files-found: error
          retention-days: 90
          compression-level: 0

  create_release:
    runs-on: ubuntu-latest
    needs: build_all_boards
    environment: github_release
    steps:
      - name: Get version info
        id: version
        run: |
          set -x
          
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            version="${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref_type }}" == "tag" ]]; then
            version=${{ github.ref_name }}
          else
            version="${GITHUB_SHA::7}"
          fi
          
          echo "version=${version}" >> $GITHUB_OUTPUT

      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: false

      - name: Organize firmware files
        run: |
          set -x
          mkdir -p release_files
          find artifacts -name "*.bin" -exec cp {} release_files/ \;
          ls -lah release_files/

      - name: List all firmware files
        if: always()
        continue-on-error: true
        run: |
          set -x
          pwd
          ls -lah release_files/
          tree release_files/ || find release_files -type f

      - name: Generate release notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # ESP32-Mirage ${{ steps.version.outputs.version }}
          
          ## ðŸŽ‰ Multi-Board Support
          
          This release includes firmware for the following boards:
          
          ### Supported Boards
          
          | Board | File | Description |
          |-------|------|-------------|
          | ESP32-DevKit | `ESP32-Mirage-${{ steps.version.outputs.version }}-esp32dev.bin` | Generic ESP32 development board |
          | LilyGo T-Display | `ESP32-Mirage-${{ steps.version.outputs.version }}-lilygo-t-display.bin` | ESP32 with built-in ST7789 display |
          | ESP32 Geek | `ESP32-Mirage-${{ steps.version.outputs.version }}-esp32-geek.bin` | ESP32-C3 with display |
          | M5Stack Core | `ESP32-Mirage-${{ steps.version.outputs.version }}-m5stack-core-esp32.bin` | M5Stack Basic/Core/Core2 |
          | M5Stack CoreS3 | `ESP32-Mirage-${{ steps.version.outputs.version }}-m5stack-cores3.bin` | M5Stack CoreS3 |
          | M5Stack Cardputer | `ESP32-Mirage-${{ steps.version.outputs.version }}-m5stack-cardputer.bin` | M5Stack Cardputer |
          | M5StickC Plus | `ESP32-Mirage-${{ steps.version.outputs.version }}-m5stick-c-plus.bin` | M5StickC Plus |
          | M5StickC Plus2 | `ESP32-Mirage-${{ steps.version.outputs.version }}-m5stick-c-plus2.bin` | M5StickC Plus2 |
          
          ## ðŸ“¥ Installation
          
          1. Download the appropriate `.bin` file for your board
          2. Flash using one of these methods:
          
          ### Method 1: Using esptool.py (Recommended)
          ```bash
          pip install esptool
          esptool.py --port /dev/ttyUSB0 write_flash 0x0 ESP32-Mirage-VERSION-BOARD.bin
          ```
          
          ### Method 2: Using PlatformIO
          ```bash
          pio run -e BOARD -t upload
          ```
          
          ### Method 3: Using ESP32 Flash Download Tool
          - Download from [Espressif](https://www.espressif.com/en/support/download/other-tools)
          - Load the .bin file at address 0x0000
          - Click "Start"
          
          ## ðŸ“– Documentation
          
          - [Getting Started Guide](https://github.com/vs4vijay/ESP32-Mirage/blob/main/GETTING_STARTED.md)
          - [Hardware Setup](https://github.com/vs4vijay/ESP32-Mirage/blob/main/HARDWARE.md)
          - [Configuration Guide](https://github.com/vs4vijay/ESP32-Mirage/blob/main/README.md#configuration)
          
          ## ðŸ› Known Issues
          
          - First boot may take longer as WiFi configuration is set up
          - Some boards may require specific pin configurations
          
          ## ðŸ’¬ Support
          
          For issues or questions, please [open an issue](https://github.com/vs4vijay/ESP32-Mirage/issues) on GitHub.
          EOF

      - name: Create Release ${{ steps.version.outputs.version }}
        uses: softprops/action-gh-release@v2
        with:
          name: "ESP32-Mirage ${{ steps.version.outputs.version }}"
          tag_name: ${{ steps.version.outputs.version }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, '-') }}
          files: |
            release_files/*.bin
          fail_on_unmatched_files: true
